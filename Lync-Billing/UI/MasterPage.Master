<%@ Master Language="C#" AutoEventWireup="true" CodeBehind="MasterPage.Master.cs" Inherits="Lync_Billing.ui.MasterPage" %>
<%@ Register Assembly="Ext.Net" Namespace="Ext.Net" TagPrefix="ext" %>

<%--<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">--%>

<!DOCTYPE html>

<html itemtype="http://schema.org/WebPage" itemscope="itemscope">
    <head id="Head1" runat="server">
        <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>

        <link rel="stylesheet" type="text/css" media="all" href="resources/css/reset.css" />
        <link rel="stylesheet" type="text/css" media="all" href="resources/css/layouts.css" />
        <link rel="stylesheet" type="text/css" media="all" href="resources/css/toolkit.css" />
        <link rel="stylesheet" type="text/css" media="all" href="resources/css/global.css" />
        <link rel="stylesheet" type="text/css" media="all" href="resources/css/green-layout.css" />
        <link rel="stylesheet" type="text/css" media="all" href="resources/css/dropdown-menu-white.css" />

        <script type="text/javascript" src="../resources/js/jquery-1.9.1.min.js"></script>
        <script type="text/javascript" src="../resources/js/browserdetector.js"></script>
        <script type="text/javascript" src="../resources/js/ext-js-specific.js"></script>

		<!--[if lte IE 9]>
		    <link rel="stylesheet" type="text/css" media="all" href="resources/css/green-layout-ie-hacks.css" />
	    <![endif]-->
        
        <script type="text/javascript">
            $(document).ready(function () {
                var referrer = $("#ThisPageReferrer").val();

                //if we are viewing the user pages, select the user-tab from the dropdown menu and the respective sidebar link
                if (referrer.search("ui_user") != -1) {
                    $('#navigation-tabs>li.selected').removeClass('selected');

                    if (referrer.search("ui_user_dashboard") != -1) {
                        $('#home-tab').addClass('selected');
                    } else if (referrer.search("ui_user") != -1) {
                        $('#user-tab').addClass('selected');
                    }

                    //Add a "selected" class to the sidebar button with the PAGE_NAME as it's id
                    //$("#" + referrer.toString()).addClass("selected");
                    var starting_index = referrer.search("ui");
                    var button_id = referrer.substr(starting_index, referrer.length);
                    $("#" + button_id).addClass("selected");
                }
            });
        </script>

        <asp:ContentPlaceHolder ID="head" runat="server">
        </asp:ContentPlaceHolder>
    </head>

    <body>
        <form id="form1" runat="server">
            <ext:ResourceManager id="resourceManager" runat="server" Theme="Gray" />

            <% if (current_session != null) { %>
                <div  class="smart-block tool-dark-bg liquid toolbar " >
                    <div class="hwrapper rtl  ">
                        <div class="col size2of3">
                            <div class="ie7flot-fix" ><!--ie7 fix-->
                                <ul id="navigation-tabs" class="vertical-navigation " >
                                    <li id="home-tab">
                                        <a title="Home" href="../user/dashboard.aspx">Home</a>
                                    </li>

                                    <% 
                                        //View the drop down menus only if the page is not a Session Page, the only thing viewed from the Navigation bar is the Home button, given that it's only viewed on the Session->Authenticate page
                                        if( ! PAGE_NAME.Contains("ui_session") ) { 
                                    %>
                                        <li id="user-tab" class="">
                                            <a href="#"><%= current_session.EffectiveDisplayName %><span class="drop"></span></a>
                                            <ul id="user-dropdown">
                                                <li class="first-child"><a title="Manage My Phone Calls" href="../user/phonecalls.aspx">Phone Calls</a></li>
                                                <li class="separator-bottom"><a title="Address Book" href="../user/addressbook.aspx">Address Book</a></li>
                                                <li class=""><a title="Bills History" href="../user/bills.aspx">Bills History</a></li>
                                                <li class=""><a title="Calls History" href="../user/history.aspx">Calls History</a></li>
                                                <li class="separator-bottom"><a title="Calls Statistics" href="../user/statistics.aspx">Calls Statistics</a></li>
                                                <% if(current_session.PrimarySipAccount == current_session.EffectiveSipAccount) { %>
                                                    <li class="separator-bottom"><a title="Telephony Rates" href="../user/rates.aspx">Telephony Rates</a></li>
                                                    <li class="last-child"><a title="Logout" href="../session/logout.aspx">Logout</a></li>
                                                <% } else { %>
                                                    <li class="last-child"><a title="Telephony Rates" href="../user/rates.aspx">Telephony Rates</a></li>
                                                <% } %>
                                            </ul>
                                        </li>

                                        <%
                                            //The first part of the condition checks if the user has an actual permission of access-elevation; the second part is to ensure that delegated user don't abuse the current user's permissions of access elevation
                                            bool is_delegate = (current_session.IsDelegate || current_session.IsDeveloper) && (current_session.PrimarySipAccount == current_session.EffectiveSipAccount) && current_session.ListOfDelegees.Count > 0;
                                            if (is_delegate)
                                            {
                                        %>
                                            <li id="switch-to-delegee" class="">
                                                <a href="#">Switch to User<span class="drop"></span></a>
                                                <ul id="delegees-dropdown">
                                                    <% foreach(KeyValuePair<string, string> delegeeRecord in current_session.ListOfDelegees) { %>
                                                        <li class="last-child">
                                                            <a href="../session/authenticate.aspx?access=delegee&identity=<%= delegeeRecord.Key %>">
                                                                <%= delegeeRecord.Value %>
                                                            </a>
                                                        </li>
                                                    <% } %>
                                                </ul>
                                            </li>
                                        <% } %>

                                        <%
                                            //The first part of the condition checks if the user has an actual permission of access-elevation; the second part is to ensure that delegated user don't abuse the current user's permissions of access elevation
                                            bool higher_access = (current_session.IsProjectAccountant || current_session.IsDeveloper || current_session.IsProjectAdmin) && (current_session.PrimarySipAccount == current_session.EffectiveSipAccount);
                                            if (higher_access) {
                                        %>
                                            <li id="switch-roles" class="">
                                                <a href="#">Elevate Access<span class="drop"></span></a>
                                                <ul id="roles-dropdown">
                                                    <% if(current_session.IsProjectAccountant || current_session.IsDeveloper) { %>
                                                        <li class="first-child last-child"><a title="Elevate Access to Accounting Role" href="../session/authenticate.aspx?access=accounting">Accounting Role</a></li>
                                                    <% } if (current_session.IsProjectAdmin || current_session.IsDeveloper) { %>
                                                        <li class="first-child last-child"><a title="Elevate Access to Administrator Role" href="../session/authenticate.aspx?access=admin">Administrator Role</a></li>
                                                    <% } if (current_session.IsSystemAdmin || current_session.IsDeveloper) { %>
                                                        <li class="first-child last-child"><a title="Elevate Access to Developer Role" href="../session/authenticate.aspx?access=sysadmin">System Admin Role</a></li>
                                                    <% } %>
                                                </ul>
                                            </li>
                                        <% } %>
                                    
                                        <% if(current_session.PrimarySipAccount != current_session.EffectiveSipAccount) { %>
                                            <li id="access-tab">
                                                <a title="Drop delegee access" href="../session/authenticate.aspx?drop=delegee">Drop Delegee Access<span class="shutdown"></span></a>
                                            </li>
                                        <% } %>
                                    <% } %>
                                </ul>
                            </div>
                        </div>
                        <!--end toolbar right nav-->
                        <div class="col size1of3 lastcol">
                            <a class="logo fl" href='../user/dashboard.aspx'>eBill</a>
                        </div>
                    </div>
                    <!--end toolbar wrapper--> 
                </div>
                <!-- toolbar block-->
            <% } else { %>
                <div  class="block tool-dark-bg liquid toolbar " >
                    <div class="hwrapper rtl  ">
                        <div class="col size1of2 "></div>
                        <!--end toolbar right nav-->
                        <div class="col size1of2 lastcol">
                            <a class="logo fl" href='../session/login.aspx'>eBill</a>
                        </div>
                    </div>
                    <!--end toolbar wrapper--> 
                </div>
                <!-- toolbar block-->
            <% } %>


            <!-- *** START OF MAIN BODY CONTENT *** -->
            <div id='main' class='main-container bottom-rounded'>
                <asp:HiddenField ID="ThisPageReferrer" runat="server" Value="" />

                <% if(PAGE_NAME.Contains("ui_user") && ! PAGE_NAME.Contains("dashboard")) { %>
                    <!-- *** START OF SIDEBAR *** -->
                    <div id='sidebar' class='sidebar block float-left w20p'>
                        <div class="block-body">
                            <ext:Panel ID="UserToolsSidebar"
                                runat="server"
                                Height="420"
                                Width="180"
                                Title="User Tools"
                                Collapsed="false"
                                Collapsible="true">
                                <Content>
                                    <div class='sidebar-section'>
                                        <div class="sidebar-section-header">
                                            <p>Manage</p>
                                        </div>
                                        <div class="sidebar-section-body">
                                            <p><a href='../user/phonecalls.aspx' id="ui_user_phonecalls">Phone Calls</a></p>
                                            <p><a href="../user/addressbook.aspx" id="ui_user_addressbook">Address Book</a></p>
                                            <!--<p><a href="#">Authorized Delegate</a></p>-->
                                        </div>
                                    </div>

                                    <div class='sidebar-section'>
                                        <div class="sidebar-section-header">
                                            <p>History</p>
                                        </div>
                                        <div class="sidebar-section-body">
                                            <p><a href='../user/bills.aspx' id="ui_user_bills">Bills History</a></p>
                                            <p><a href='../user/history.aspx' id="ui_user_history">Phone Calls History</a></p>
                                        </div>
                                    </div>

                                    <div class='sidebar-section'>
                                        <div class="sidebar-section-header">
                                            <p>Statistics</p>
                                        </div>
                                        <div class="sidebar-section-body">
                                            <p><a href='../user/statistics.aspx' id="ui_user_statistics">Phone Calls Statistics</a></p>
                                        </div>
                                    </div>

                                    <div class='sidebar-section'>
                                        <div class="sidebar-section-header">
                                            <p>Telephony Rates</p>
                                        </div>
                                        <div class="sidebar-section-body">
                                            <p><a href='../user/rates.aspx' id="ui_user_rates">View Telephony Rates</a></p>
                                        </div>
                                    </div>
                                </Content>
                            </ext:Panel>
                        </div>
                    </div>
                    <!-- *** END OF SIDEBAR *** -->
                <% } %>

                <asp:ContentPlaceHolder ID="main_content_place_holder" runat="server">
                </asp:ContentPlaceHolder>
            </div>
            <!-- *** END OF MAIN BODY CONTENT *** -->

            <% if( ! PAGE_NAME.Contains("ui_session")) { %>
                <div class='clear'></div>
                
		        <div id='footer' class='footer-container bottom-rounded top-rounded'>
                    <p>CCC eBill, powered by MOA R&D.</p>
                    <p>For any inquiries please contact the MOA HELPDESK (<a class="bold" href="mailto:helpdesk@ccc.gr">helpdesk@ccc.gr</a>).</p>
		        </div>
            <% } %>
        </form>
    </body>
</html>
